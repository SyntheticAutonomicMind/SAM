# SPDX-License-Identifier: GPL-3.0-only
# SPDX-FileCopyrightText: Copyright (c) 2025 Andrew Wyatt (Fewtarius)

name: CI - Build and Test

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'project-docs/**'
      - 'scratch/**'
      - 'licenses/**'
      - 'ai-assisted/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/FUNDING.yml'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'project-docs/**'
      - 'scratch/**'
      - 'licenses/**'
      - 'ai-assisted/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/FUNDING.yml'

jobs:
  build:
    name: Build Debug
    runs-on: [self-hosted]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.2'
    
    - name: Download Metal Toolchain
      run: |
        echo "Downloading Metal Toolchain for Xcode 26.2..."
        sudo xcodebuild -downloadComponent MetalToolchain || echo "Metal Toolchain already installed or download failed"
    
    - name: Build SAM (Debug)
      run: make build-debug

  validate:
    name: Validate Python Bundle
    runs-on: [self-hosted, macos, sam-builder-001]
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.2'
    
    - name: Build SAM (Debug)
      run: make build-debug
    
    - name: Validate Python Bundle
      run: ./scripts/validate_python_bundle.sh Debug

  test:
    name: Run Tests
    runs-on: [self-hosted, macos, sam-builder-001]
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.2'
    
    - name: Build SAM (Debug)
      run: make build-debug
    
    - name: Run unit tests
      run: make test || echo "Tests not yet implemented"
    
    - name: Verify build artifacts
      run: |
        ls -la .build/Build/Products/Debug/SAM.app
        ls -la .build/Build/Products/Debug/SAM.app/Contents/MacOS/SAM
